---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../../../components/reloader-chart/

commonAnnotations:
  argocd.argoproj.io/sync-options: Delete=false

helmCharts:
  - name: reloader
    releaseName: reloader
    namespace: reloader
    repo: https://stakater.github.io/stakater-charts
    version: "1.1.0"
    valuesInline:
      nameOverride: reloader
      fullnameOverride: reloader
      reloader:
        isOpenshift: true

patches:
  - target:
      kind: Deployment
      name: reloader
    patch: |-
      - op: replace
        path: /spec/template/spec/securityContext
        value: {}
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: GOMAXPROCS
            valueFrom:
              resourceFieldRef:
                divisor: '0'
                resource: limits.cpu
          - name: GOMEMLIMIT
            valueFrom:
              resourceFieldRef:
                divisor: '0'
                resource: limits.memory
